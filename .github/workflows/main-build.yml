name: Main Build

# Triggers when code is merged to main branch
on:
  push:
    branches:
      - main
      - master

# Only run one build at a time for main branch
concurrency:
  group: main-build
  cancel-in-progress: false

jobs:
  # Full build and test of all services
  build-and-test:
    name: Build and Test All Services
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Backend setup and build
      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore .NET dependencies
        run: dotnet restore src/Hbg.sln

      - name: Build .NET solution
        run: dotnet build src/Hbg.sln --configuration Release --no-restore

      - name: Run .NET tests
        run: dotnet test src/Hbg.sln --configuration Release --no-build --verbosity normal

      # Frontend setup and build
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: src/Web/Web.SPA/Client/package-lock.json

      - name: Install frontend dependencies
        working-directory: src/Web/Web.SPA/Client
        run: npm ci

      - name: Build Angular app
        working-directory: src/Web/Web.SPA/Client
        run: npm run build --if-present

      - name: Run frontend tests
        working-directory: src/Web/Web.SPA/Client
        run: npm run test:ci --if-present || echo "‚ö†Ô∏è No test:ci script found"

      # Summary
      - name: Build summary
        run: |
          echo "üéâ Main branch build completed successfully!"
          echo "‚úÖ All backend services built"
          echo "‚úÖ All backend tests passed"
          echo "‚úÖ Frontend built for production"
          echo "‚úÖ Frontend tests passed"
          echo ""
          echo "Ready for deployment! üöÄ"

  # Create a build artifact for deployment (optional)
  create-artifacts:
    name: Create Build Artifacts
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # Publish backend services
      - name: Publish API.Files service
        run: dotnet publish src/Services/API/Files/API.Files.csproj -c Release -o ./publish/api-files

      - name: Publish API.Constructor service
        run: dotnet publish src/Services/API/Constructor/API.Constructor.csproj -c Release -o ./publish/api-constructor

      # Upload artifacts for deployment
      - name: Upload API.Files artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-files
          path: ./publish/api-files
          retention-days: 7

      - name: Upload API.Constructor artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-constructor
          path: ./publish/api-constructor
          retention-days: 7

      - name: Artifacts summary
        run: |
          echo "üì¶ Build artifacts created:"
          echo "  - api-files"
          echo "  - api-constructor"
          echo ""
          echo "Artifacts available for 7 days for deployment workflows"
